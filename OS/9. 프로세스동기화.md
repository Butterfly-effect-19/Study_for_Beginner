# 7. 프로세스 동기화


## 프로세스 동기화

: 하나의 자원을 한 순간에 하나의 프로세스만이 이용하도록 제어하는 것. 

### 목적

- 원하는 결과값을 도출하도록 임계구역 문제를 해결한다.
- 프로세스의 실행 순서를 원하는대로 제어한다.
- Busy wait 등과 같은 비효율성을 제거한다.

## 임계구역(cretical section)

: 여러 개의 쓰레드가 수행되는 시스템에서 각 쓰레드들이 공유하는 데이터(변수, 테이블, 파일 등)를 변경하는 코드 영역

```java
bool lock = false;
int balance;

int main(){
  while(lock==true);
  lock = true;
  balance = balance + 10; //임계구역
  lock = false;
```

### 임계구역을 해결하기 위한 3가지 조건

- Mutual exclusion 상호배제
    
    : 오직 한 쓰레드만이 진입가능하다. 한 쓰레드가 임계구역에서 수행 중인 상태에서는 다른 쓰레드는 절대 이 구역에 접근할 수 없다. 
    
- Progress 진행
    
    : 임계 구역에 들어간 프로세스가 없는 상태에서 들어가려고하는 프로세스가 여러 개 있다면, 어느 것이 들어갈지를 적절히 결정해줘야한다. 즉, 한 프로세스가 다른 프로세스의 진행을 방해해서는 안된다.
    
- Bounded waiting 한정대기
    
    임계구역으로 진입하기 위해 대기하는 모든 쓰레드는 유한 시간 이내에 해당 임계구역으로 진입할 수 있어야한다. 
    

임계구역의 동시접근을 해결하기 위한 방법으로는 lock, semaphore, monitor 등이 대표적이다. 

## Lock 락

: 하나의 쓰레드나 프로세스가 자원을 사용하는 동안에는 잠궈서 접근을 못하게 하는 방식. 

단점 : 2개의 프로세스가 동시에 공유자원에 접근하는 경우. 

## Semaphore 세마포어

: 동시에 자원을 접근할 수 있도록 허용한 공유자원의 수를 나타내는 것. 

1. 임계구역에 진입하기 전 '사용 중'으로 설정하고 임계구역에 들어간다
2. 이후에 도착하는 프로세스는 앞의 프로세스가 작업을 마칠 때까지 기다린다. 
3. 프로세스가 작업을 마치면 세마포어는 다음 프로세스에 임계구역을 사용하라는 동기화 신호를 보낸다. 
4. 세마포어에서 잠금이 해제되기를 기다리는 프로세스는 세마포어큐에 저장되어있다가 wake_up 신호를 받으면 임계구역에 진입한다.  따라서 바쁜대기를 하는 프로세스가 없다.

```java
Semaphore(n); //RS = n; 
P();    //if(RS > 0) RS = RS -1;  (RS 1빼고 임계구역 진입)
        //else block(); (0보다 커질때까지 대기)

/*임계구역*/

V();    //RS = RS + 1;
        //wake_up(); (세마포어에서 기다리는 프로세스에게 임계구역에 진입하라는 신호)
```

- Semaphore(n) : 전역변수 RS를 n으로 초기화. RS에는 현재 사용가능한 자원의 수가 저장.
- P() : 잠금을 수행하는 코드. RS가 0보다 크면(사용 가능한 자원이 있으면) 1만큼 감소시키고 임계구역에 진입한다. 만약 RS가 0볻 작으면(사용가능한 자원이 없으면) 0보다 커질 때까지 기다린다.
- V() : 잠금 해제와 동기화를 같이 수행하는 코드, RS값을 1증가시키고 세마포어에서 기다리는 프로세스에게 임계구역에 진입해도 좋다는 wake_up 신호를 보냄.
- 대기할 때는 block() 코드 사용.

단점 : 

- 세마포어의 P()나 V()의 내부코드가 실행되는 도중에 다른 코드가 실행되면 상호배제 와 한정 대기 조건을 보장하지 못한다.
- 사용자의 실수 또는 고의로 세마포어를 사용하지 않게되면 임계구역이 보호받지 못한다.
    - 공유자원을 사용할 떄 모든 프로세스가 세마포어 알고리즘을 따른다면 굳이 P( )와 V( )를 사용할 필요없이 자동으로 처리하면된다.  → 이를 구현한 것이 모니터.

## monitor 모니터

: 공유자원을 내부적으로 숨기고 공유 자원에 접근하기 위한 인터페이스만을 제공함으로써 자원을 보호하고 프로세스 간에 동기화를 시킨다. 

1. 임계구역으로 지정된 변수나 자원에 접근하고자하는 프로세스는 직접 P( )나 V( )를 사용하지 않고 모니터에 작업 요청을 한다. 
2. 모니터는 요청받은 작업을 모니터 큐에 저장한 후 순서대로 처리하고 그 결과만 해당 프로세스에 알려준다. 

: